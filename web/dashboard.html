<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—äººäº¤äº’å¹³å° v7</title>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="lib/bootstrap-icons/font/bootstrap-icons.css?v=2">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --background-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --border-radius: 10px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .dashboard-container {
            width: 100%;
            height: 100%;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .dashboard-container .row {
            flex: 1;
            margin: 0;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            align-items: stretch;
        }

        .dashboard-container .col-lg-8 {
            flex: 1;
            min-width: 300px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        /* è§†é¢‘å¡ç‰‡ç­‰é«˜ */
        .col-lg-8 .card {
            flex: 1 !important;
            height: 100% !important;
            display: flex;
            flex-direction: column;
        }
        
        .dashboard-container .col-lg-4 {
            flex: 0 0 420px;
            min-width: 380px;
            max-width: 500px;
            min-height: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .dashboard-container .card {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            width: 100%;
        }

        .card-body {
            flex: 1;
            overflow: auto;
        }
        
        /* å³ä¾§å¯¹è¯åŒºåŸŸä½¿ç”¨ flexbox å‚ç›´å¸ƒå±€ */
        .col-lg-4 .card-body {
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .input-controls {
            flex-shrink: 0;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: none;
            margin-bottom: 0;
            overflow: hidden;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 15px 20px;
            border-bottom: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: transparent;
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }

        video {
            width: auto;
            height: 100%;
            max-width: 100%;
            object-fit: contain;
            border-radius: var(--border-radius);
            display: block;
            margin: 0;
            padding: 0;
        }
        
        /* è§†é¢‘å¡ç‰‡æ— å†…è¾¹è· */
        .col-lg-8 .card-body.p-0 {
            padding: 0 !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .form-control {
            border-radius: var(--border-radius);
            padding: 10px 15px;
            border: 1px solid #ced4da;
        }

        .form-control:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-connected {
            background-color: #28a745;
        }

        .status-disconnected {
            background-color: #dc3545;
        }

        .status-connecting {
            background-color: #ffc107;
        }

        .asr-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #ced4da;
            min-height: 200px;
        }

        .asr-text {
            margin-bottom: 10px;
            padding: 10px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .user-message {
            background-color: #e3f2fd;
            border-left: 4px solid var(--primary-color);
        }

        .system-message {
            background-color: #f1f8e9;
            border-left: 4px solid #8bc34a;
        }

        .settings-panel {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-top: 15px;
        }
        
        .btn-send {
            min-width: 80px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0 !important;
        }
        
        .btn-voice {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            border-radius: var(--border-radius);
            transition: all 0.2s ease;
        }
        
        .btn-voice:active,
        .btn-voice.recording {
            background-color: #bd2130 !important;
            border-color: #bd2130 !important;
            transform: scale(0.98);
        }
        
        .btn-voice i {
            font-size: 18px;
            margin-right: 5px;
        }
        
        .voice-control {
            margin-top: 10px;
        }
        
        .input-group textarea {
            border-radius: var(--border-radius) 0 0 var(--border-radius) !important;
        }
        
        .recording-pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(220, 53, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }
        
        /* å“åº”å¼å¸ƒå±€ */
        /* è¶…å®½å± - å¯¹è¯æ¡†å¯ä»¥æ›´å®½ */
        @media (min-width: 1600px) {
            .dashboard-container .col-lg-4 {
                flex: 0 0 500px;
            }
        }
        
        /* ä¸­ç­‰å±å¹• */
        @media (max-width: 1200px) {
            .dashboard-container .col-lg-4 {
                flex: 0 0 400px;
            }
        }
        
        @media (max-width: 992px) {
            .dashboard-container .col-lg-8 {
                min-width: 250px;
            }
            .dashboard-container .col-lg-4 {
                flex: 0 0 380px;
                min-width: 350px;
            }
        }
        
        /* å°å±å¹• - æ”¹ä¸ºä¸Šä¸‹å¸ƒå±€ */
        @media (max-width: 768px) {
            .dashboard-container .row {
                flex-direction: column;
            }
            .dashboard-container .col-lg-8,
            .dashboard-container .col-lg-4 {
                max-width: 100%;
                width: 100%;
                flex: 0 0 auto;
            }
            .dashboard-container .col-lg-8 {
                height: 50%;
            }
            .dashboard-container .col-lg-4 {
                height: 50%;
                min-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="row">
            <!-- è§†é¢‘åŒºåŸŸ -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="video-container">
                            <video id="video" autoplay playsinline muted></video>
                        </div>
                        
                        <!-- STUN æœåŠ¡å™¨é»˜è®¤å¯ç”¨ -->
                        <input type="hidden" id="use-stun" checked>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§äº¤äº’ -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <div class="asr-container mb-3" id="chat-messages">
                        </div>
                        
                        <div class="input-controls">
                            <form id="chat-form">
                                <div class="input-group mb-3">
                                    <textarea class="form-control" id="chat-message" rows="3" placeholder="è¾“å…¥æ‚¨æƒ³å¯¹æ•°å­—äººè¯´çš„è¯..."></textarea>
                                    <button class="btn btn-primary btn-send" type="submit">
                                        <i class="bi bi-send-fill"></i> å‘é€
                                    </button>
                                </div>
                            </form>
                            
                            <!-- æŒ‰ä½è¯´è¯æŒ‰é’® -->
                            <div class="voice-control">
                                <button class="btn btn-danger btn-voice" type="button" id="voice-record-btn">
                                    <i class="bi bi-mic-fill"></i> æŒ‰ä½è¯´è¯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—çš„ä¼šè¯ID -->
    <input type="hidden" id="sessionid" value="0">


    <script src="client.js?v=8"></script>
    <script src="srs.sdk.js"></script>
    <script src="lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="lib/jquery/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // é¡µé¢åŠ è½½åç«‹å³è°ƒç”¨ start()
            // æµè§ˆå™¨å¯èƒ½ä¼šé˜»æ­¢è‡ªåŠ¨æ’­æ”¾ï¼Œä½†è¿æ¥ä¼šå»ºç«‹
            setTimeout(function() {
                if (typeof start === 'function') {
                    start();
                    console.log('è‡ªåŠ¨è¿æ¥å·²å¯åŠ¨');
                }
            }, 500);
            
            // ç›‘å¬ä»»ä½•ç”¨æˆ·äº¤äº’ï¼Œç¡®ä¿è§†é¢‘æœ‰å£°éŸ³
            var hasInteracted = false;
            function handleFirstInteraction() {
                if (!hasInteracted) {
                    hasInteracted = true;
                    var video = document.getElementById('video');
                    if (video) {
                        // è§£é™¤é™éŸ³ä»¥è·å¾—å£°éŸ³
                        if (video.muted) {
                            video.muted = false;
                            console.log('ç”¨æˆ·äº¤äº’ï¼šè§†é¢‘å·²è§£é™¤é™éŸ³');
                        }
                        // å¦‚æœè§†é¢‘æš‚åœäº†ï¼Œæ’­æ”¾å®ƒ
                        if (video.paused) {
                            video.play().catch(e => console.log('è§†é¢‘æ’­æ”¾å°è¯•'));
                        }
                    }
                }
            }
            
            // åœ¨å¤šä¸ªäº‹ä»¶ä¸Šç›‘å¬ç¬¬ä¸€æ¬¡ç”¨æˆ·äº¤äº’
            $(document).one('click keydown touchstart', handleFirstInteraction);

            // æ·»åŠ èŠå¤©æ¶ˆæ¯
            function addChatMessage(message, type = 'user') {
                const messagesContainer = $('#chat-messages');
                const messageClass = type === 'user' ? 'user-message' : 'system-message';
                const sender = type === 'user' ? 'æ‚¨' : 'æ•°å­—äºº';
                
                const messageElement = $(`
                    <div class="asr-text ${messageClass}">
                        ${sender}: ${message}
                    </div>
                `);
                
                messagesContainer.append(messageElement);
                messagesContainer.scrollTop(messagesContainer[0].scrollHeight);
            }


            // èŠå¤©æ¨¡å¼è¡¨å•æäº¤
            $('#chat-form').on('submit', function(e) {
                e.preventDefault();
                
                // é¦–æ¬¡æäº¤æ—¶è§£é™¤è§†é¢‘é™éŸ³
                var video = document.getElementById('video');
                if (video && video.muted) {
                    video.muted = false;
                    console.log('ğŸ“¢ å‘é€æ¶ˆæ¯ï¼šè§†é¢‘å·²è§£é™¤é™éŸ³');
                }
                
                var message = $('#chat-message').val();
                if (!message.trim()) return;
                
                fetch('/human', {
                    body: JSON.stringify({
                        text: message,
                        type: 'chat',
                        interrupt: true,
                        sessionid: parseInt(document.getElementById('sessionid').value),
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    method: 'POST'
                });
                
                addChatMessage(message, 'user');
                $('#chat-message').val('');
            });

            // æŒ‰ä½è¯´è¯åŠŸèƒ½
            let mediaRecorder;
            let audioChunks = [];
            let isRecording = false;
            let recognition;
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³è¯†åˆ«
            const isSpeechRecognitionSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
            
            if (isSpeechRecognitionSupported) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'zh-CN';
                
                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                            $('#chat-message').val(interimTranscript);
                        }
                    }
                    
                    if (finalTranscript) {
                        $('#chat-message').val(finalTranscript);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                };
            }
            
            // æŒ‰ä½è¯´è¯æŒ‰é’®äº‹ä»¶
            $('#voice-record-btn').on('mousedown touchstart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                startRecording();
            }).on('mouseup mouseleave touchend touchcancel', function(e) {
                e.preventDefault();
                e.stopPropagation();
                if (isRecording) {
                    stopRecording();
                }
            });
            
            // å¼€å§‹å½•éŸ³
            function startRecording() {
                if (isRecording) return;
                
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒ getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.error('æµè§ˆå™¨ä¸æ”¯æŒ getUserMedia API');
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨æ–‡å­—è¾“å…¥ã€‚');
                    return;
                }
                
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        audioChunks = [];
                        mediaRecorder = new MediaRecorder(stream);
                        
                        mediaRecorder.ondataavailable = function(e) {
                            if (e.data.size > 0) {
                                audioChunks.push(e.data);
                            }
                        };
                        
                        mediaRecorder.start();
                        isRecording = true;
                        
                        $('#voice-record-btn').addClass('recording');
                        
                        if (recognition) {
                            try {
                                recognition.start();
                            } catch(e) {
                                console.warn('è¯­éŸ³è¯†åˆ«å¯åŠ¨å¤±è´¥:', e);
                            }
                        }
                    })
                    .catch(function(error) {
                        console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£ã€‚å¦‚æœåœ¨ iframe ä¸­ä½¿ç”¨ï¼Œè¯·ç¡®ä¿çˆ¶é¡µé¢å…è®¸éº¦å…‹é£æƒé™ã€‚');
                    });
            }

            function stopRecording() {
                if (!isRecording) return;
                
                mediaRecorder.stop();
                isRecording = false;
                
                // åœæ­¢æ‰€æœ‰éŸ³è½¨
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                // è§†è§‰åé¦ˆæ¢å¤
                $('#voice-record-btn').removeClass('recording');
                
                // åœæ­¢è¯­éŸ³è¯†åˆ«
                if (recognition) {
                    recognition.stop();
                }
                
                // è·å–è¯†åˆ«çš„æ–‡æœ¬å¹¶å‘é€
                setTimeout(function() {
                    const recognizedText = $('#chat-message').val().trim();
                    if (recognizedText) {
                        // å‘é€è¯†åˆ«çš„æ–‡æœ¬
                        fetch('/human', {
                            body: JSON.stringify({
                                text: recognizedText,
                                type: 'chat',
                                interrupt: true,
                                sessionid: parseInt(document.getElementById('sessionid').value),
                            }),
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            method: 'POST'
                        });
                        
                        addChatMessage(recognizedText, 'user');
                        $('#chat-message').val('');
                    }
                }, 500); 
            }


            // SRS WebRTCæ’­æ”¾åŠŸèƒ½
            var sdk = null; // å…¨å±€å¤„ç†å™¨ï¼Œç”¨äºåœ¨é‡æ–°å‘å¸ƒæ—¶è¿›è¡Œæ¸…ç†

            function startPlay() {
                // å…³é—­ä¹‹å‰çš„è¿æ¥
                if (sdk) {
                    sdk.close();
                }
                
                sdk = new SrsRtcWhipWhepAsync();
                $('#video').prop('srcObject', sdk.stream);
                
                var host = window.location.hostname;
                var url = "http://" + host + ":1985/rtc/v1/whep/?app=live&stream=livestream";
                
                sdk.play(url).then(function(session) {
                    console.log('WebRTCæ’­æ”¾å·²å¯åŠ¨ï¼Œä¼šè¯ID:', session.sessionid);
                }).catch(function(reason) {
                    sdk.close();
                    console.error('WebRTCæ’­æ”¾å¤±è´¥:', reason);
                });
            }
        });
    </script>
</body>
</html>